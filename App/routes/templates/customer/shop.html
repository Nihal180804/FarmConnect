{% extends "base.html" %}
{% block content %}

<!-- Products Section - Full Width (no sidebar) -->
<div>
    
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-primary to-emerald-600 rounded-2xl shadow-lg p-8 text-white mb-8">
      <h1 class="text-4xl font-bold mb-2">Fresh From Farmers</h1>
      <p class="text-lg text-green-100">Premium fresh produce delivered directly from local farms</p>
    </div>

    <!-- Top Search & Filters (matches screenshot) -->
    <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-6">
      <div class="flex-1">
        <div class="relative">
          <input id="searchInput" type="search" placeholder="Search products..." class="w-full px-4 py-3 rounded-full border border-gray-200 shadow-sm focus:ring-2 focus:ring-emerald-400" />
          <button id="searchClear" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm text-gray-500 hidden">Clear</button>
        </div>
      </div>

      <div class="flex gap-3">
        <select id="topCategory" class="px-4 py-3 rounded-lg border border-gray-200 bg-white">
          <option value="all">All Categories</option>
          <option value="vegetables">Vegetables</option>
          <option value="fruits">Fruits</option>
          <option value="grains">Grains</option>
          <option value="dairy">Dairy</option>
          <option value="organic">Organic Products</option>
        </select>

        <select id="topPrice" class="px-4 py-3 rounded-lg border border-gray-200 bg-white">
          <option value="999999">All Prices</option>
          <option value="50">Under ₹50</option>
          <option value="100">Under ₹100</option>
          <option value="250">Under ₹250</option>
          <option value="500">Under ₹500</option>
          <option value="1000">Under ₹1000</option>
        </select>

        <select id="topSort" class="px-4 py-3 rounded-lg border border-gray-200 bg-white">
          <option value="newest">Sort: Newest</option>
          <option value="price-low">Price: Low to High</option>
          <option value="price-high">Price: High to Low</option>
          <option value="rating">Highest Rated</option>
        </select>
      </div>
    </div>

    <!-- Season Filter Buttons -->
    <div class="mb-6">
      <div class="flex items-center gap-3 flex-wrap">
        <span class="text-sm font-semibold text-gray-700">Filter by Season:</span>
        <button onclick="filterBySeason('all')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-emerald-500 text-white shadow-md hover:bg-emerald-600 active" data-season="all">
          <i class="fas fa-leaf mr-2"></i>All Seasons
        </button>
        <button onclick="filterBySeason('Summer')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-white border-2 border-orange-300 text-orange-600 hover:bg-orange-50" data-season="summer">
          <i class="fas fa-sun mr-2"></i>Summer
        </button>
        <button onclick="filterBySeason('Winter')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-white border-2 border-blue-300 text-blue-600 hover:bg-blue-50" data-season="winter">
          <i class="fas fa-snowflake mr-2"></i>Winter
        </button>
        <button onclick="filterBySeason('Monsoon')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-white border-2 border-teal-300 text-teal-600 hover:bg-teal-50" data-season="monsoon">
          <i class="fas fa-cloud-rain mr-2"></i>Monsoon
        </button>
        <button onclick="filterBySeason('Spring')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-white border-2 border-pink-300 text-pink-600 hover:bg-pink-50" data-season="spring">
          <i class="fas fa-seedling mr-2"></i>Spring
        </button>
        <button onclick="filterBySeason('Autumn')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-white border-2 border-amber-300 text-amber-600 hover:bg-amber-50" data-season="autumn">
          <i class="fas fa-leaf-maple mr-2"></i>Autumn
        </button>
        <button onclick="filterBySeason('Year-Round')" class="season-btn px-6 py-2 rounded-full font-semibold transition-all bg-white border-2 border-purple-300 text-purple-600 hover:bg-purple-50" data-season="year-round">
          <i class="fas fa-calendar mr-2"></i>Year-Round
        </button>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="productsGrid">
      {% for p in products %}
      <div class="product-card group bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden border border-gray-200" data-category="{{ p.CategoryName|lower if p.CategoryName else 'other' }}" data-price="{{ p.Price }}" data-rating="4.5" data-name="{{ p.ProductName|lower }}" data-season="{{ p.SeasonName|lower if p.SeasonName else 'all year' }}">
        
        <!-- Product Image Container -->
        <div class="relative w-full h-48 bg-gradient-to-br from-green-100 to-emerald-50 overflow-hidden">
          <img src="{{ url_for('static', filename='images/products/' + (p.ImagePath if p.ImagePath else 'placeholder.jpg')) }}" alt="{{ p.ProductName }}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" onerror="this.onerror=null; this.src='https://via.placeholder.com/400x300/10b981/ffffff?text={{ p.ProductName }}'">
          
          <!-- Price Badge -->
          <div class="absolute top-3 right-3 bg-gradient-to-r from-primary to-emerald-600 text-white px-4 py-2 rounded-full font-bold text-lg shadow-lg">
            ₹{{ "%.2f"|format(p.Price) }}
          </div>
          
          <!-- Category Badge -->
          <div class="absolute top-3 left-3 bg-white bg-opacity-90 text-primary px-3 py-1 rounded-full text-xs font-semibold">
            {{ p.CategoryName if p.CategoryName else 'Fresh' }}
          </div>
        </div>

        <!-- Product Info -->
        <div class="p-5 space-y-3 bg-gradient-to-br from-amber-50 to-orange-50">
          <!-- Product Name -->
          <h3 class="text-lg font-bold text-gray-900 group-hover:text-emerald-600 transition-colors line-clamp-2">
            {{ p.ProductName }}
          </h3>
          
          <!-- Farmer Info -->
          <p class="text-sm text-gray-700 flex items-center gap-2">
            <i class="fas fa-user-circle text-emerald-600"></i>
            <span class="font-medium">{{ p.FarmerName }}</span>
          </p>
          
          <!-- Rating -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-1">
              <div class="flex text-amber-400">
                <i class="fas fa-star text-xs"></i>
                <i class="fas fa-star text-xs"></i>
                <i class="fas fa-star text-xs"></i>
                <i class="fas fa-star text-xs"></i>
                <i class="fas fa-star-half-alt text-xs"></i>
              </div>
              <span class="text-xs font-semibold text-gray-700">4.5</span>
            </div>
            <span class="text-xs text-gray-600">(18)</span>
          </div>

          <!-- Stock Level -->
          <div class="flex items-center gap-2 {% if p.QuantityAvailable <= 10 %}text-red-600{% elif p.QuantityAvailable <= 50 %}text-amber-600{% else %}text-green-600{% endif %}">
            <i class="fas fa-box text-sm"></i>
            <span class="text-sm font-semibold">
              {% if p.QuantityAvailable == 0 %}
                Out of Stock
              {% elif p.QuantityAvailable <= 10 %}
                Only {{ p.QuantityAvailable }} left!
              {% elif p.QuantityAvailable <= 50 %}
                {{ p.QuantityAvailable }} available
              {% else %}
                In Stock ({{ p.QuantityAvailable }})
              {% endif %}
            </span>
          </div>

          <!-- Divider -->
          <div class="border-t border-amber-200"></div>

          <!-- Add to Cart -->
          <form method="post" action="{{ url_for('customer.cart_add') }}" class="add-to-cart-form flex gap-2 pt-2" data-product-id="{{ p.ProductID }}" data-available="{{ p.QuantityAvailable }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="product_id" value="{{ p.ProductID }}">
            <input type="number" name="quantity" value="1" min="1" max="{{ p.QuantityAvailable }}" class="w-16 px-2 py-2 border border-amber-300 rounded-lg text-center font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-white bg-opacity-60" {% if p.QuantityAvailable == 0 %}disabled{% endif %}>
            <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-all transform hover:scale-105 active:scale-95 shadow-md flex items-center justify-center gap-2" {% if p.QuantityAvailable == 0 %}disabled{% endif %}>
              <i class="fas fa-shopping-cart"></i>
              <span>{% if p.QuantityAvailable == 0 %}Sold Out{% else %}Add{% endif %}</span>
            </button>
          </form>
        </div>
      </div>
      {% else %}
      <div class="col-span-full">
        <div class="bg-amber-50 bg-opacity-60 rounded-2xl shadow-lg p-16 text-center border border-amber-200 backdrop-blur">
          <i class="fas fa-inbox text-6xl text-amber-300 mb-6"></i>
          <p class="text-2xl font-semibold text-gray-700 mb-2">No Products Found</p>
          <p class="text-gray-600">Try selecting a different category or check back soon for new items</p>
        </div>
      </div>
      {% endfor %}
    </div>

</div>

<script>
// Category Filter
document.querySelectorAll('.category-filter').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const category = this.getAttribute('data-category');
    
    document.querySelectorAll('.category-filter').forEach(b => {
      b.classList.remove('border-primary', 'bg-primary', 'text-white');
      b.classList.add('border-gray-300', 'text-gray-700');
    });
    
    this.classList.add('border-primary', 'bg-primary', 'text-white');
    this.classList.remove('border-gray-300', 'text-gray-700');
    
    filterAndSort();
  });
});

// Top controls
document.getElementById('searchInput')?.addEventListener('input', function() {
  const val = this.value.trim();
  document.getElementById('searchClear').style.display = val ? 'inline' : 'none';
  filterAndSort();
});
document.getElementById('searchClear')?.addEventListener('click', function(e){
  e.preventDefault();
  const inp = document.getElementById('searchInput');
  if (inp) { inp.value = ''; this.style.display = 'none'; filterAndSort(); }
});
document.getElementById('topCategory')?.addEventListener('change', filterAndSort);
document.getElementById('topPrice')?.addEventListener('change', filterAndSort);
document.getElementById('topSort')?.addEventListener('change', filterAndSort);

// Season filter functionality
let currentSeason = 'all';

function filterBySeason(season) {
  currentSeason = season.toLowerCase();
  
  console.log('Filtering by season:', currentSeason);
  
  // Update button styles
  document.querySelectorAll('.season-btn').forEach(btn => {
    if (btn.getAttribute('data-season').toLowerCase() === currentSeason) {
      btn.classList.remove('bg-white', 'border-2');
      btn.classList.add('bg-emerald-500', 'text-white', 'shadow-md', 'active');
    } else {
      btn.classList.add('bg-white', 'border-2');
      btn.classList.remove('bg-emerald-500', 'text-white', 'shadow-md', 'active');
    }
  });
  
  filterAndSort();
}

function filterAndSort() {
  const topCategory = document.getElementById('topCategory')?.value || 'all';
  const category = (topCategory && topCategory !== 'all') ? topCategory : 'all';
  const sortBy = document.getElementById('topSort')?.value || 'newest';
  const maxPrice = parseInt(document.getElementById('topPrice')?.value || 999999);
  const searchTerm = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
  
  // Get ALL product cards (including hidden ones)
  let allCards = Array.from(document.querySelectorAll('.product-card'));
  
  // Track which cards match the filters
  let matchedCards = [];
  let hiddenCount = 0;
  
  allCards.forEach(card => {
    const cardCategory = card.getAttribute('data-category') || '';
    const cardPrice = parseFloat(card.getAttribute('data-price')) || 0;
    const cardName = (card.getAttribute('data-name') || '').toLowerCase();
    const cardSeason = (card.getAttribute('data-season') || '').toLowerCase();
    
    console.log('Card:', cardName, 'Season:', cardSeason, 'Looking for:', currentSeason);
    
    const categoryMatch = category === 'all' || cardCategory === category;
    const priceMatch = cardPrice <= maxPrice;
    const searchMatch = !searchTerm || cardName.includes(searchTerm);
    
    // Season matching: check if the card's season string contains the selected season
    let seasonMatch = currentSeason === 'all';
    if (!seasonMatch) {
      // Check if the product's season list contains the selected season or is year-round
      seasonMatch = cardSeason.includes(currentSeason) || cardSeason.includes('year-round');
    }
    
    console.log('  -> Match?', seasonMatch, 'Category:', categoryMatch, 'Price:', priceMatch, 'Search:', searchMatch);
    
    if (categoryMatch && priceMatch && searchMatch && seasonMatch) {
      matchedCards.push(card);
      card.style.display = '';
    } else {
      card.style.display = 'none';
      hiddenCount++;
    }
  });
  
  // Sort the matched cards
  matchedCards.sort((a, b) => {
    const priceA = parseFloat(a.getAttribute('data-price'));
    const priceB = parseFloat(b.getAttribute('data-price'));
    const ratingA = parseFloat(a.getAttribute('data-rating'));
    const ratingB = parseFloat(b.getAttribute('data-rating'));
    
    if (sortBy === 'price-low') return priceA - priceB;
    if (sortBy === 'price-high') return priceB - priceA;
    if (sortBy === 'rating') return ratingB - ratingA;
    return 0;
  });
  
  // Reorder the grid
  const grid = document.getElementById('productsGrid');
  
  // Remove "no products" message if it exists
  const noProductsMsg = grid.querySelector('.col-span-full');
  if (noProductsMsg) {
    noProductsMsg.remove();
  }
  
  // Append matched cards in sorted order
  matchedCards.forEach(card => {
    grid.appendChild(card);
  });
  
  // Append hidden cards at the end (so they're still in DOM)
  allCards.forEach(card => {
    if (card.style.display === 'none') {
      grid.appendChild(card);
    }
  });
  
  // Show "no products" message if nothing matches
  if (matchedCards.length === 0) {
    const noProductsDiv = document.createElement('div');
    noProductsDiv.className = 'col-span-full';
    noProductsDiv.innerHTML = `
      <div class="bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200">
        <i class="fas fa-inbox text-6xl text-gray-300 mb-6"></i>
        <p class="text-2xl font-semibold text-gray-600 mb-2">No Products Found</p>
        <p class="text-gray-500 mt-2">Try adjusting your filters or search term</p>
      </div>
    `;
    grid.insertBefore(noProductsDiv, grid.firstChild);
  }
}

// Add fade-in animation
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .product-card:hover { transform: translateY(-8px); }
`;
document.head.appendChild(style);

// Add to cart AJAX functionality
document.querySelectorAll('.add-to-cart-form').forEach(form => {
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btn = this.querySelector('button[type="submit"]');
    const btnText = btn.querySelector('span');
    const originalText = btnText.textContent;
    
    btnText.textContent = 'Adding...';
    btn.disabled = true;
    
    fetch(this.action, {
      method: 'POST',
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        btnText.textContent = 'Added!';
        btn.classList.remove('from-emerald-500', 'to-teal-500');
        btn.classList.add('from-green-600', 'to-green-700');
        
        // Show success message
        const msg = document.createElement('div');
        msg.className = 'fixed top-20 right-4 z-50 bg-green-100 text-green-700 border border-green-300 px-6 py-3 rounded-lg shadow-lg flex items-center gap-2';
        msg.innerHTML = '<i class="fas fa-check-circle"></i><span>Added to cart!</span>';
        document.body.appendChild(msg);
        
        setTimeout(() => {
          msg.style.opacity = '0';
          msg.style.transform = 'translateX(100px)';
          msg.style.transition = 'all 0.5s ease-out';
          setTimeout(() => msg.remove(), 500);
        }, 2000);
        
        setTimeout(() => {
          btnText.textContent = originalText;
          btn.classList.add('from-emerald-500', 'to-teal-500');
          btn.classList.remove('from-green-600', 'to-green-700');
          btn.disabled = false;
        }, 2000);
      } else {
        alert(data.message || 'Error adding to cart');
        btnText.textContent = originalText;
        btn.disabled = false;
      }
    })
    .catch(err => {
      alert('Error adding to cart');
      btnText.textContent = originalText;
      btn.disabled = false;
    });
  });
});
</script>

{% endblock %}
