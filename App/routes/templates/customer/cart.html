{% extends "base.html" %}
{% block content %}
<div class="py-8 px-4">
  <div class="max-w-6xl mx-auto">
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900">Shopping Cart</h1>
      <p class="text-gray-700 mt-2">{{ items|length }} items in your cart</p>
    </div>

  {% if items %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white">
              <tr>
                <th class="px-6 py-4 text-left text-sm font-semibold">Product</th>
                <th class="px-6 py-4 text-left text-sm font-semibold">Price</th>
                <th class="px-6 py-4 text-left text-sm font-semibold">Quantity</th>
                <th class="px-6 py-4 text-left text-sm font-semibold">Subtotal</th>
                <th class="px-6 py-4 text-left text-sm font-semibold">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-amber-200">
              {% for item in items %}
              <tr class="hover:bg-amber-50 transition-colors">
                <td class="px-6 py-4 text-gray-900 font-medium">{{ item.Name }}</td>
                <td class="px-6 py-4 text-gray-900">₹{{ "%.2f"|format(item.Price|float) }}</td>
                <td class="px-6 py-4">
                  <input type="number" class="qty-input w-20 px-3 py-2 border border-amber-300 rounded-lg text-center font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white bg-opacity-70" value="{{ item.quantity }}" min="1" data-product-id="{{ item.ProductID }}">
                </td>
                <td class="px-6 py-4 text-gray-900 font-bold">₹{{ "%.2f"|format(item.subtotal|float) }}</td>
                <td class="px-6 py-4">
                  <button class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors" onclick="removeFromCart({{ item.ProductID }})"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div>
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 sticky top-20">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Order Summary</h3>
        <div class="space-y-3 border-b border-amber-200 pb-4 mb-4">
          <div class="flex justify-between text-gray-900">
            <span>Subtotal:</span>
            <span>₹{{ "%.2f"|format(total|float) }}</span>
          </div>
          <div class="flex justify-between text-gray-900">
            <span>Shipping:</span>
            <span>₹0.00</span>
          </div>
          <div class="flex justify-between text-gray-900">
            <span>Tax:</span>
            <span>₹0.00</span>
          </div>
        </div>
        <div class="flex justify-between mb-6">
          <strong class="text-lg text-gray-900">Total:</strong>
          <strong class="text-lg text-emerald-600">₹{{ "%.2f"|format(total|float) }}</strong>
        </div>
        <a href="{{ url_for('customer.checkout') }}" class="block w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-all mb-3 text-center">
          <i class="fas fa-credit-card mr-2"></i>Proceed to Checkout
        </a>
        <a href="{{ url_for('customer.shop') }}" class="block w-full text-center bg-amber-200 hover:bg-amber-300 text-gray-900 font-semibold py-3 px-4 rounded-lg transition-colors">
          <i class="fas fa-arrow-left mr-2"></i>Continue Shopping
        </a>
      </div>
    </div>
  </div>

  {% else %}
  <div>
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-12 text-center">
      <i class="fas fa-shopping-cart text-6xl text-amber-300 mb-6"></i>
      <h3 class="text-2xl font-bold text-gray-900 mb-2">Your cart is empty</h3>
      <p class="text-gray-700 mb-6">Add some fresh products from our farmers!</p>
      <a href="{{ url_for('customer.shop') }}" class="inline-block px-8 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold rounded-lg hover:shadow-lg transition-all">
        <i class="fas fa-shopping-cart mr-2"></i>Start Shopping
      </a>
    </div>
  </div>
  {% endif %}
</div>

<script>
function removeFromCart(productId) {
  if (confirm('Remove this item from cart?')) {
    fetch("{{ url_for('customer.cart_update') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        product_id: productId,
        quantity: 0,
        csrf_token: '{{ csrf_token() }}'
      })
    }).then(r => r.json()).then(j => {
      if (j.success) {
        location.reload();
      } else {
        alert('Error updating cart');
      }
    });
  }
}

function placeOrder() {
  if (confirm('Confirm your order?')) {
    fetch("{{ url_for('customer.order_place') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({csrf_token: '{{ csrf_token() }}'})
    }).then(r => r.json()).then(j => {
      if (j.success) {
        alert('Order placed successfully!');
        location.href = "{{ url_for('customer.shop') }}";
      } else {
        alert('Error: ' + (j.message || 'Failed to place order'));
      }
    });
  }
}

// Update cart when quantity changes
document.querySelectorAll('.qty-input').forEach(input => {
  input.addEventListener('change', function() {
    const productId = this.getAttribute('data-product-id');
    const quantity = this.value;
    
    fetch("{{ url_for('customer.cart_update') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        product_id: productId,
        quantity: quantity,
        csrf_token: '{{ csrf_token() }}'
      })
    }).then(r => r.json()).then(j => {
      if (j.success) {
        location.reload();
      }
    });
  });
});
</script>

{% endblock %}
